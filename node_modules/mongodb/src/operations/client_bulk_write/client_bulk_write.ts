import { type Connection } from 'mongodb/src/cmap/connection';
import { ClientBulkWriteCursorResponse } from 'mongodb/src/cmap/wire_protocol/responses';
import type { ClientSession } from 'mongodb/src/sessions';
import { MongoDBNamespace } from 'mongodb/src/utils';
import { CommandOperation } from 'mongodb/src/operations/command';
import { Aspect, defineAspects } from 'mongodb/src/operations/operation';
import { type ClientBulkWriteCommand, type ClientBulkWriteCommandBuilder } from 'mongodb/src/operations/client_bulk_write/command_builder';
import { type ClientBulkWriteOptions } from 'mongodb/src/operations/client_bulk_write/common';

/**
 * Executes a single client bulk write operation within a potential batch.
 * @internal
 */
export class ClientBulkWriteOperation extends CommandOperation<ClientBulkWriteCursorResponse> {
  override SERVER_COMMAND_RESPONSE_TYPE = ClientBulkWriteCursorResponse;

  commandBuilder: ClientBulkWriteCommandBuilder;
  override options: ClientBulkWriteOptions;

  override get commandName() {
    return 'bulkWrite' as const;
  }

  constructor(commandBuilder: ClientBulkWriteCommandBuilder, options: ClientBulkWriteOptions) {
    super(undefined, options);
    this.commandBuilder = commandBuilder;
    this.options = options;
    this.ns = new MongoDBNamespace('admin', '$cmd');
  }

  override resetBatch(): boolean {
    return this.commandBuilder.resetBatch();
  }

  override get canRetryWrite(): boolean {
    return this.commandBuilder.isBatchRetryable;
  }

  override handleOk(
    response: InstanceType<typeof this.SERVER_COMMAND_RESPONSE_TYPE>
  ): ClientBulkWriteCursorResponse {
    return response;
  }

  override buildCommandDocument(
    connection: Connection,
    _session?: ClientSession
  ): ClientBulkWriteCommand {
    const command = this.commandBuilder.buildBatch(
      connection.description.maxMessageSizeBytes,
      connection.description.maxWriteBatchSize,
      connection.description.maxBsonObjectSize
    );

    // Check _after_ the batch is built if we cannot retry it and override the option.
    if (!this.canRetryWrite) {
      this.options.willRetryWrite = false;
    }

    return command;
  }
}

// Skipping the collation as it goes on the individual ops.
defineAspects(ClientBulkWriteOperation, [
  Aspect.WRITE_OPERATION,
  Aspect.SKIP_COLLATION,
  Aspect.CURSOR_CREATING,
  Aspect.RETRYABLE,
  Aspect.COMMAND_BATCHING,
  Aspect.SUPPORTS_RAW_DATA
]);
